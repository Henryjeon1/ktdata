name: Full Update NPB_par


on:
  workflow_run:
    workflows: ["Update_AAA.yml"]
    types:
      - completed  # ì²« ì›Œí¬í”Œë¡œìš°ê°€ ì™„ë£Œë˜ë©´ ìë™ ì‹¤í–‰
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©

jobs:
  update-NPB:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pip install pandas pyarrow requests pymysql jq

      - name: NPB ë¦¬ê·¸ ë°ì´í„° ìƒì„±
        run: python NPB_generate_data_par.py
        env:
          PW: ${{ secrets.PW }}

      - name: ë¦´ë¦¬ìŠ¤ì— NPB ë°ì´í„° ì—…ë¡œë“œ
        run: |
          TAG_NAME="KoreaBaseballOrganization"
          FILE_PATH="NPB.parquet"
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"

          echo "ğŸ“¦ ë¦´ë¦¬ìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
          RELEASE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "$API_URL/tags/${TAG_NAME}")
          RELEASE_ID=$(echo "$RELEASE_DATA" | jq -r '.id')

          if [[ "$RELEASE_ID" == "null" ]]; then
            echo "ğŸ”„ ë¦´ë¦¬ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
            RESPONSE=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -d "{\"tag_name\": \"$TAG_NAME\", \"name\": \"$TAG_NAME\", \"body\": \"ìë™ ìƒì„± ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤.\"}" \
              "$API_URL")
            RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id')
          fi

          echo "ğŸ†— ë¦´ë¦¬ìŠ¤ ID: $RELEASE_ID"

          # ê¸°ì¡´ì— ê°™ì€ ì´ë¦„ì˜ assetì´ ìˆìœ¼ë©´ ì‚­ì œ
          ASSETS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "$API_URL/$RELEASE_ID/assets")
          for row in $(echo "$ASSETS" | jq -r '.[] | @base64'); do
            _jq() {
              echo "${row}" | base64 --decode | jq -r "${1}"
            }
            NAME=$(_jq '.name')
            ID=$(_jq '.id')
            if [[ "$NAME" == "$(basename $FILE_PATH)" ]]; then
              echo "ğŸ—‘ï¸ ê¸°ì¡´ asset ì‚­ì œ: $NAME"
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                "$API_URL/assets/$ID"
            fi
          done

          echo "â¬†ï¸ íŒŒì¼ ì—…ë¡œë“œ: $FILE_PATH"
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --upload-file "$FILE_PATH" \
            "https://uploads.github.com/repos/${{ github.repository }}/releases/${RELEASE_ID}/assets?name=$(basename $FILE_PATH)"

          echo "âœ… ì—…ë¡œë“œ ì™„ë£Œ!"
