name: Full Update_par

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pip install pandas pyarrow requests pymysql jq tqdm

      - name: Run KBO ë°ì´í„° ìƒì„±
        run: python KBO_generate_data_par.py
        env:
          PW: ${{ secrets.PW }}

      - name: Releaseì— ë°ì´í„° ì—…ë¡œë“œ
        run: |
          TAG_NAME="KoreaBaseballOrganization"
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          FILE_NAME="KoreaBaseballOrganization.parquet"
          FILE_PATH="${FILE_NAME}"

          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"

          # ë¦´ë¦¬ìŠ¤ ì¡´ì¬ í™•ì¸
          RELEASE_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "$API_URL/tags/${TAG_NAME}")

          if [[ "$RELEASE_EXISTS" == *"Not Found"* ]]; then
            echo "ğŸ”„ ë¦´ë¦¬ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
            RELEASE_RESPONSE=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -d "{\"tag_name\": \"${TAG_NAME}\", \"name\": \"${TAG_NAME}\", \"body\": \"ì—…ë°ì´íŠ¸ëœ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤.\"}" \
              "$API_URL")
          else
            echo "âœ… ë¦´ë¦¬ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤."
            RELEASE_RESPONSE="$RELEASE_EXISTS"

            # ê¸°ì¡´ íŒŒì¼(asset) ì‚­ì œ
            ASSET_ID=$(echo "$RELEASE_RESPONSE" | jq -r \
              --arg NAME "$FILE_NAME" '.assets[] | select(.name == $NAME) | .id')

            if [[ -n "$ASSET_ID" ]]; then
              echo "ğŸ§¹ ê¸°ì¡´ íŒŒì¼ $FILE_NAME ì‚­ì œ ì¤‘ (asset_id=$ASSET_ID)"
              curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                "$API_URL/assets/${ASSET_ID}"
            else
              echo "â„¹ï¸ ê¸°ì¡´ íŒŒì¼ $FILE_NAME ì—†ìŒ"
            fi
          fi

          # ì—…ë¡œë“œ URL ì¶”ì¶œ
          UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url' | sed -e "s/{?name,label}//")

          if [[ "$UPLOAD_URL" == "null" || -z "$UPLOAD_URL" ]]; then
            echo "âŒ ì—…ë¡œë“œ URLì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘: $FILE_NAME"
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --upload-file "${FILE_PATH}" \
            "${UPLOAD_URL}?name=${FILE_NAME}"

          echo "âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!"

      - name: Minor ë°ì´í„° ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/Update_minor.yml/dispatches \
            -d '{
              "ref": "main",
              "inputs": {
                "pw": "'"${{ inputs.pw }}"'"
              }
            }'
