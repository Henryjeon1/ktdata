# This is a basic workflow to help you get started with Actions

name: Full Update_par

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      pw:
        description: "ë°ì´í„°ë² ì´ìŠ¤ ë¹„ë°€ë²ˆí˜¸"
        required: true
        type: string  # ì…ë ¥ íƒ€ì…ì„ ë¬¸ìì—´ë¡œ ì„¤ì •

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ì‹¤í–‰ ì‹œê°„ ì œí•œì„ 60ë¶„ìœ¼ë¡œ ì„¤ì •
    permissions:
      contents: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pip install pandas pyarrow requests pymysql jq
      
      - name: Run KBO ë°ì´í„° ìƒì„±
        run: python KBO_generate_data_par.py
        env:
          PW: ${{ inputs.pw }}

      - name: Run Minor ë°ì´í„° ìƒì„±
        run: python Minor_generate_data_par.py
        env:
          PW: ${{ inputs.pw }}


      - name: Releaseì— ë‘ íŒŒì¼ ì—…ë¡œë“œ
        run: |
          TAG_NAME="KoreaBaseballOrganization"
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}

          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"
          RELEASE_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "$API_URL/tags/${TAG_NAME}")
          
          if [[ "$RELEASE_EXISTS" == *"Not Found"* ]]; then
            echo "ğŸ”„ ë¦´ë¦¬ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤."
          else
            echo "ğŸ§¹ ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
            RELEASE_ID=$(echo "$RELEASE_EXISTS" | jq -r '.id')
            curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
              "$API_URL/$RELEASE_ID"
          fi

          echo "ğŸš€ ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
          RELEASE_RESPONSE=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -d "{\"tag_name\": \"${TAG_NAME}\", \"name\": \"${TAG_NAME}\", \"body\": \"ì—…ë°ì´íŠ¸ëœ ë¦´ë¦¬ìŠ¤ì…ë‹ˆë‹¤.\"}" \
            "$API_URL")

          UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url' | sed -e "s/{?name,label}//")

          for FILE_PATH in "KoreaBaseballOrganization.parquet" "Minor.parquet"
          do
            echo "ğŸ“¤ ${FILE_PATH} ì—…ë¡œë“œ ì¤‘..."
            curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --upload-file "${FILE_PATH}" \
              "${UPLOAD_URL}?name=$(basename ${FILE_PATH})"
          done

          echo "âœ… ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!"
