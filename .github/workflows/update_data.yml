# This is a basic workflow to help you get started with Actions

name: Update Data Daily

on:
  schedule:
    - cron: "0 5 * * *"  # ë§¤ì¼ 00:00 UTCì— ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: pip install pandas pyarrow requests pymysql jq

      - name: ë°ì´í„° ìƒì„± ì‹¤í–‰
        run: python generate_data.py

      - name: Releaseì— ë°ì´í„° ì—…ë¡œë“œ
        run: |
          TAG_NAME=$(date +'%Y-%m-%d')  # ì˜¤ëŠ˜ ë‚ ì§œë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}

          # ë¦´ë¦¬ìŠ¤ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"
          RELEASE_EXISTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG_NAME}")

          if [[ "$RELEASE_EXISTS" == *"Not Found"* ]]; then
            echo "ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
            RELEASE_RESPONSE=$(curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -d "{\"tag_name\": \"${TAG_NAME}\", \"name\": \"${TAG_NAME}\", \"body\": \"ë¦´ë¦¬ìŠ¤ ë‚´ìš©\"}" \
            "$API_URL")
          else
            echo "ê¸°ì¡´ ë¦´ë¦¬ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."
            RELEASE_ID=$(echo "$RELEASE_EXISTS" | jq -r '.id')
            RELEASE_RESPONSE=$(curl -s -X PATCH -H "Authorization: token $GITHUB_TOKEN" \
            -d "{\"name\": \"${TAG_NAME}\", \"body\": \"ì—…ë°ì´íŠ¸ëœ ë‚´ìš©\"}" \
            "$API_URL/$RELEASE_ID")
          fi

          # ì—…ë¡œë“œí•  íŒŒì¼ ê²½ë¡œ
          FILE_PATH="data.csv"

          # ë¦´ë¦¬ìŠ¤ ìƒì„± í›„ ì—…ë¡œë“œ URL ê°€ì ¸ì˜¤ê¸°
          UPLOAD_URL=$(echo "$RELEASE_RESPONSE" | jq -r '.upload_url' | sed -e "s/{?name,label}//")

          # ì—…ë¡œë“œ URLì´ ì •ìƒì¸ì§€ í™•ì¸
          if [[ "$UPLOAD_URL" == "null" || -z "$UPLOAD_URL" ]]; then
            echo "âŒ ì—…ë¡œë“œ URLì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "ğŸ”— ì—…ë¡œë“œ URL: $UPLOAD_URL"

          # GitHub Releaseì— íŒŒì¼ ì—…ë¡œë“œ
          curl -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"${FILE_PATH}" \
            "${UPLOAD_URL}?name=$(basename ${FILE_PATH})"

          echo "âœ… íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!"
