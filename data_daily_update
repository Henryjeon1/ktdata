import os
import sys
import pandas as pd
import requests
from datetime import datetime

# âœ… GitHub ì •ë³´ ì„¤ì •
OWNER = "Henryjeon1"
REPO = "Trackman"
GITHUB_TOKEN = "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"

# âœ… ë‚ ì§œ ì…ë ¥ (ì§ì ‘ ì§€ì • ê°€ëŠ¥)
if len(sys.argv) > 1:
    TARGET_DATE = sys.argv[1]  # ì‹¤í–‰ ì‹œ ì¸ìë¡œ ë‚ ì§œ ì…ë ¥ ê°€ëŠ¥ (ì˜ˆ: '2025-03-27')
else:
    TARGET_DATE = input("ì—…ë°ì´íŠ¸í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: YYYY-MM-DD): ")

# âœ… GitHub Releasesì—ì„œ CSV ë‹¤ìš´ë¡œë“œ
TAG_NAME = TARGET_DATE  # ì…ë ¥í•œ ë‚ ì§œë¥¼ íƒœê·¸ë¡œ ì‚¬ìš©
release_url = f"https://api.github.com/repos/{OWNER}/{REPO}/releases/tags/{TAG_NAME}"
headers = {"Authorization": f"token {GITHUB_TOKEN}"}

response = requests.get(release_url, headers=headers)
if response.status_code == 200:
    release_data = response.json()
    asset_url = release_data["assets"][0]["browser_download_url"]
    print(f"ğŸ“Œ CSV ë‹¤ìš´ë¡œë“œ URL: {asset_url}")

    # CSV íŒŒì¼ì„ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ì½ê¸°
    df = pd.read_csv(asset_url)

    # âœ… ê¸°ì¡´ ë°ì´í„°ì—ì„œ TARGET_DATE ì‚­ì œ
    df = df[df["Date"] != TARGET_DATE]

    # âœ… SQLì—ì„œ ìƒˆë¡œìš´ TARGET_DATE ë°ì´í„° ê°€ì ¸ì˜¤ê¸°  
    new_data = pd.DataFrame({
        "Date": [TARGET_DATE] * 5,
        "Value": [100, 200, 300, 400, 500]
    })  # ì‹¤ì œë¡œëŠ” SQLì—ì„œ ê°€ì ¸ì™€ì•¼ í•¨

    # âœ… ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€
    df = pd.concat([df, new_data], ignore_index=True)

    # âœ… ì—…ë°ì´íŠ¸ëœ CSV ë‹¤ì‹œ ì €ì¥ & ì—…ë¡œë“œ
    df.to_csv("data.csv", index=False)

    print(f"âœ… {TARGET_DATE} ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
else:
    print(f"âŒ ë¦´ë¦¬ìŠ¤ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ (HTTP {response.status_code})")
